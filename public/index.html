<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="icons/favicon.png">
    <link rel="stylesheet" href="styles/index.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script defer src="scripts/index.js?v=dbg1"></script>
    <title>wplacer</title>
</head>

<body>
    <div class="container">
        <h1><img src="icons/favicon.png">wplacer</h1>

        <div id="main">
            <button id="openManageUsers" class="primary-button"><img src="icons/manageUsers.svg">Manage Users</button>
            <button id="openAddTemplate" class="primary-button"><img src="icons/addTemplate.svg">Add Template</button>
            <button id="openManageTemplates" class="primary-button"><img src="icons/manageTemplates.svg">Manage
                Templates</button>
            <button id="openSettings" class="primary-button"><img src="icons/settings.svg">Settings</button>
        </div>

        <div id="manageUsers" style="display: none;">
            <h2>Add/Manage Users</h2>
            <form id="userForm">
                <label for="jcookie">JWT Cookie (j)</label>
                <input type="password" id="jcookie" required>
                <label for="scookie">Session Cookie (s) [optional]</label>
                <input type="password" id="scookie">
                <button type="submit" id="submitUser" class="primary-button"><img src="icons/addUser.svg">Add
                    User</button>
            </form>

            <h2 class="section-title" id="manageUsersTitle">Existing Users</h2>
            <div id="chargeSummary">
                <b>Total Available Charges:</b> <span id="totalCharges">?</span> |
                <b>Total Max Charges:</b> <span id="totalMaxCharges">?</span>
            </div>
            <button id="checkUserStatus" class="primary-button"><img src="icons/check.svg">Check Account Status</button>
            <!-- 新增的工具栏按钮/控件 -->
            <button id="bulkSyncSelectedBtn" class="primary-button">
                <img src="icons/sync.svg">批量同步（已选）
            </button>
            
            <select id="groupSelect" class="secondary-select" title="Group filter">
                <option value="">— Group —</option>
            </select>
            
            <button id="bulkSyncGroupBtn" class="primary-button">
                <img src="icons/sync.svg">批量同步（分组）
            </button>
            
            <button id="assignGroupBtn" class="secondary-button">
                <img src="icons/tag.svg">将所选设置为组
            </button>
            
            <div id="userList"></div>

            <button onclick="changeTab(main);" class="secondary-button"><img src="icons/return.svg">Return</button>
        </div>

        <div id="addTemplate" style="display: none;">
            <h2 id="templateFormTitle">Add Template</h2>
            <div class="info-box">
                <b>Tip:</b> For best results, process your image through the <a href="https://pepoafonso.github.io/color_converter_wplace/" target="_blank" rel="noopener noreferrer">wplace color converter</a> first!
            </div>
            <button id="convert" class="primary-button" onclick="document.getElementById('convertInput').click()"><img src="icons/convert.svg">Convert Image</button>
            <div id="details" style="display: none;">
                <b>Size:</b> <span id="size"></span> | <b>Charges needed:</b> <span id="ink"></span>
                <div id="premiumWarning" class="warning-box" style="display: none;"></div>
                <canvas id="templateCanvas"></canvas>
                <div class="preview-controls">
                    <button id="previewCanvasButton" class="secondary-button">Preview Canvas</button>
                    <label for="previewBorder">Preview Border:</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="previewBorder" value="0">
                </div>
                <canvas id="previewCanvas" style="display: none;"></canvas>
            </div>
            <form id="templateForm">
                <input type="file" style="display: none;" accept="image/png" id="convertInput">
                <label for="templateName">Template Name</label>
                <input type="text" id="templateName" placeholder="Insert a catchy name here" required>
                <label>Coordinates (Ctrl-V anywhere to paste pin coordinates or a list of 4 numbers)</label>
                <div class="coordinate-grid">
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="tx" placeholder="Tile X" required>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="ty" placeholder="Tile Y" required>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="px" placeholder="Pixel X" required>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="py" placeholder="Pixel Y" required>
                </div>
                <label for="userSelectList">Users</label>
                
<div class="user-toolbar">
  <input id="userFilter" type="text" placeholder="筛选用户（姓名 / ID / 邮箱）">
  <button id="btnAll" type="button" class="secondary-button">全选</button>
  <button id="btnNone" type="button" class="secondary-button">清空</button>
  <button id="btnInvert" type="button" class="secondary-button">反选</button>
</div>

                <div id="userSelectList"></div>
                <button type="button" id="selectAllUsers" class="secondary-button"><img src="icons/manageUsers.svg">Select All</button>

                <div class="setting-group">
                   <label style="display:block;margin-bottom:6px;">Buy charges mode</label>
                   <div id="purchaseModeFieldset" role="radiogroup" aria-label="Buy charges mode"
                        class="radio-row">
                     <label style="margin-right:14px;">
                       <input type="radio" name="purchaseMode" id="pmNone"   value="none"   checked>
                       Do not buy
                     </label>
                     <label style="margin-right:14px;">
                       <input type="radio" name="purchaseMode" id="pmNormal" value="normal">
                       Buy charges (+5)
                     </label>
                     <label>
                       <input type="radio" name="purchaseMode" id="pmMax"    value="max">
                       Buy max upgrades (+30)
                     </label>
                   </div>
                </div>
                
                <div class="setting-toggle">
                    <label for="antiGriefMode">Enable Anti Grief mode</label>
                    <label class="switch">
                        <input id="antiGriefMode" name="antiGriefMode" type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-toggle">
                    <label for="enableAutostart">Enable Autostart</label>
                    <label class="switch">
                        <input id="enableAutostart" name="enableAutostart" type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>

                <button type="submit" id="submitTemplate" class="primary-button"><img src="icons/addTemplate.svg">Add Template</button>
            </form>
            <button onclick="changeTab(main); resetTemplateForm();" class="secondary-button"><img src="icons/return.svg">Return</button>
        </div>

        <div id="manageTemplates" style="display: none;">
            <h2>Manage Templates</h2>
            <div class="template-actions-all">
                <button id="startAll" class="primary-button"><img src="icons/playAll.svg">Start All</button>
                <button id="stopAll" class="secondary-button"><img src="icons/pauseAll.svg">Stop All</button>
            </div>
            <div id="templateList"></div>
            <button onclick="changeTab(main);" class="secondary-button"><img src="icons/return.svg">Return</button>
        </div>

        <div id="settings" style="display: none;">
            <h2>Settings</h2>

            <label for="drawingDirectionSelect">Drawing Direction</label>
            <select id="drawingDirectionSelect">
                <option value="ttb">Top to Bottom</option>
                <option value="btt">Bottom to Top</option>
                <option value="ltr">Left to Right</option>
                <option value="rtl">Right to Left</option>
                <option value="center_out">Center Out</option>
            </select>

            <label for="drawingOrderSelect">Drawing Order</label>
            <select id="drawingOrderSelect">
                <option value="linear">Linear</option>
                <option value="random">Random Pixels</option>
                <option value="randomColor">Random Color</option>
                <option value="color">Color by Color</option>
            </select>

            <label for="pixelSkipSelect">Drawing Density</label>
            <select id="pixelSkipSelect">
                <option value="1">1/1 (Every Pixel)</option>
                <option value="2">1/2</option>
                <option value="4">1/4</option>
                <option value="8">1/8</option>
                <option value="16">1/16</option>
                <option value="32">1/32</option>
                <option value="64">1/64</option>
                <option value="128">1/128</option>
            </select>

            <div class="setting-toggle">
                <label for="outlineMode">Enable outline mode</label>
                <label class="switch">
                    <input id="outlineMode" name="outlineMode" type="checkbox">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-toggle">
                <label for="skipPaintedPixels">Skip other's painted pixels</label>
                <label class="switch">
                    <input id="skipPaintedPixels" name="skipPaintedPixels" type="checkbox">
                    <span class="slider"></span>
                </label>
            </div>

            <label for="accountCooldown">Account Turn Cooldown (seconds)</label>
            <input type="number" id="accountCooldown" min="0" value="20">
            <label for="purchaseCooldown">Purchase Cooldown (seconds)</label>
            <input type="number" id="purchaseCooldown" min="0" value="5">
            <label for="accountCheckCooldown">Account Check Cooldown (seconds)</label>
            <input type="number" id="accountCheckCooldown" min="0" value="0">
            <label for="dropletReserve">Minimum Droplets Before Buying</label>
            <input type="number" id="dropletReserve" min="0" value="0">
            <label for="antiGriefStandby">Anti-Grief Standby Time (minutes)</label>
            <input type="number" id="antiGriefStandby" min="1" value="10">
            <label for="chargeThreshold">Charge Threshold (%)</label>
            <input type="number" id="chargeThreshold" min="0" max="100" value="50">
            
            <h2 class="section-title">Proxy Settings</h2>
            <div class="setting-toggle">
                <label for="proxyEnabled">Enable Rotating Proxies</label>
                <label class="switch">
                    <input id="proxyEnabled" name="proxyEnabled" type="checkbox">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="proxyFormContainer" style="display: none;">
                <p class="info-box" style="text-align: left;">Proxies are loaded from the <code>proxies.txt</code> file in your <code>/data</code> folder. Add one proxy per line in the format <code>protocol://user:pass@host:port</code>. You can get high quality proxies at <a href="https://dataimpulse.com/?aff=199137" target="_blank" rel="noopener noreferrer">DataImpulse</a>.</p>
                <div class="setting-toggle">
                    <label for="logProxyUsage">Log Proxy Connections</label>
                    <label class="switch">
                        <input id="logProxyUsage" name="logProxyUsage" type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <label for="proxyRotationMode">Rotation Mode</label>
                <select id="proxyRotationMode">
                    <option value="sequential">Sequential</option>
                    <option value="random">Random</option>
                </select>
                <div id="proxyCount" class="info-box" style="text-align: center; margin-top: 10px;"></div>
                <button type="button" id="reloadProxiesBtn" class="secondary-button">Reload Proxies from File</button>
            </div>

            <button onclick="changeTab(main);" class="secondary-button"><img src="icons/return.svg">Return</button>
        </div>

        <p class="credits">Made by <a href="https://github.com/luluwaffless">luluwaffless <img src="icons/github.svg"></a> and <a href="https://github.com/JinxTheCatto">Jinx <img src="icons/github.svg"></a>
        </p>
    </div>

    <div id="messageBoxOverlay" class="hidden">
        <div id="messageBox">
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <div class="message-box-buttons">
                <button id="messageBoxCancel" class="secondary-button">Cancel</button>
                <button id="messageBoxConfirm" class="primary-button">OK</button>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="scripts/index.js"></script>
    
    <script type="text/javascript" src="scripts/progress-eta.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const btnGroup    = document.getElementById("bulkSyncGroupBtn");
          const selectGroup = document.getElementById("groupSelect");
        
          btnGroup.addEventListener("click", async () => {
            console.log("[handler] bulkSyncGroupBtn clicked", Date.now());
        
            // 1) 取分组ID + 该组内账号（示例选择器，按你的实际结构改）
            const groupId = selectGroup?.value || "";
            if (!groupId) {
              alert("请先在下拉框选择一个分组。");
              return;
            }
        
            // 假设每个卡片有 data-user-id 和 data-group-id
            const groupUsers = Array.from(document.querySelectorAll(".user-card"))
              .filter(card => card.getAttribute("data-group-id") === groupId)
              .map(card => card.getAttribute("data-user-id"))
              .filter(Boolean);
        
            console.log("[bulkSyncGroup] groupId:", groupId, "users:", groupUsers);
        
            if (groupUsers.length === 0) {
              alert("这个分组里没有账号可同步。");
              return;
            }
        
            if (!confirm(`将以你当前已登录的主号状态，依次为该分组 ${groupUsers.length} 个账号执行同步。继续？`)) {
              return;
            }
        
            // 2) 立刻开一个测试弹窗，检查是否被拦截（必须在用户手势栈内）
            const testWin = window.open("", "_blank", "noopener,noreferrer,width=800,height=700");
            if (!testWin || testWin.closed) {
              alert("浏览器拦截了弹窗：请在地址栏右侧将本站的弹窗设置为“允许”，再试一次。");
              return;
            }
            testWin.document.write("<p style='font-family:sans-serif'>准备同步…</p>");
            testWin.document.close();
        
            // 3) UI 状态
            const originalText = btnGroup.innerText;
            btnGroup.disabled = true;
            btnGroup.innerText = "分组同步中…";
        
            try {
              // 4) 为每个账号预开窗口（保证不被拦），随后异步设置URL
              const popupWins = groupUsers.map(() => {
                const w = window.open("", "_blank", "noopener,noreferrer,width=800,height=700");
                return w;
              });
        
              // 若任何一个被拦截，提示一次
              if (popupWins.some(w => !w || w.closed)) {
                alert("有弹窗被拦截：请允许弹窗后重试。");
                popupWins.forEach(w => { try { w && w.close(); } catch(e){} });
                return;
              }
        
              // 5) 这里构建每个账号的同步URL —— 用你可用的后端替换
              //    ✅ 推荐改成你本机： http://127.0.0.1:3000/sync?to=<uid>&cb=<回调>
              //    ⚠️ 不要再用 backend.wplace.live（之前404）
              const backend = "http://127.0.0.1:3000";
              const cb      = location.origin; // 或你想回调的地址
        
              groupUsers.forEach((uid, i) => {
                const url = `${backend}/sync?to=${encodeURIComponent(uid)}&cb=${encodeURIComponent(cb)}`;
                console.log("[bulkSyncGroup] open:", url);
                // 立即把空白页导航到目标URL
                popupWins[i].location.replace(url);
              });
        
              alert(`已为分组中的 ${groupUsers.length} 个账号发起同步窗口。若无自动跳转，请检查后端 /sync 路由是否存在。`);
            } catch (err) {
              console.error(err);
              alert(`分组同步失败：${err.message || err}`);
            } finally {
              btnGroup.disabled = false;
              btnGroup.innerText = originalText;
              try { testWin && !testWin.closed && testWin.close(); } catch(e){}
            }
          });
        });
        </script>
        
        

</body>

</html>